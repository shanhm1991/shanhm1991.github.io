<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="utf-8">
  
  <title>Http调用工具spring-feign 使用文档 | Echo</title>
  <meta name="author" content="shanhm1991">
  
  <meta name="description" content="介绍一下如何使用spring-feign进行远程服务调用，以及springboot应用中的一些常用处理，包括请求id追踪，统一的异常处理和日志打印等问题">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="Http调用工具spring-feign 使用文档"/>
  <meta property="og:site_name" content="Echo"/>

  
    <meta property="og:image" content=""/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Echo" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  
<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	ga('create', 'UA-147251181-1', 'auto');
	ga('send', 'pageview');

</script>


<meta name="generator" content="Hexo 4.2.0"></head>


<body>
  <header id="header" class="inner"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="alignleft">
  <h1><a href="/">Echo</a></h1>
  <span style="color:#736f6f; height:20px;line-height:30px;">It's a long long way to go</span>
  <h2><font style="color: #736f6f;">articles:  109 &nbsp;&nbsp;&nbsp; views: <span id="busuanzi_value_site_uv"></span></font></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/about">Abount</a></li>
    
      <li><a href="/books">Books</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>

<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article id="post-20210505" class="h-entry post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time class="dt-published" datetime="2021-05-04T16:00:00.000Z" style="margin-bottom: 10px;"><a href="/2021/05/05/20210505/" style="color: #736f6f;">2021-05-05</a></time>
      
      

  
  
    <h1 class="p-name title" itemprop="headline name">
        Http调用工具spring-feign 使用文档
    </h1>
    
    
  
  
  


<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


   <span style="line-height:35px; height:35px; ">  </span>

   <font style="color: #999;"> words: 5k  &nbsp;&nbsp; views: <span id="busuanzi_value_page_pv"></span> &nbsp;&nbsp; time: 27min</font>
   
   
  
  <div class="categories">
    <a href="/categories/开发笔记/">开发笔记</a>
  </div>


   
   
  
  <div class="tags">
    <a href="/tags/feign/">feign</a>
  </div>


   
   <hr style="background-color: #ddd; height:1px; border:none;" /><br>
   


    </header>
      
    <div class="e-content entry" itemprop="articleBody">
      
        <p>介绍一下如何使用spring-feign进行远程服务调用，以及springboot应用中的一些常用处理，包括请求id追踪，统一的异常处理和日志打印等问题<br><a id="more"></a></p>
<h3 id="Feign调用"><a href="#Feign调用" class="headerlink" title="Feign调用"></a>Feign调用</h3><h4 id="指定url"><a href="#指定url" class="headerlink" title="指定url"></a>指定url</h4><figure class="highlight java"><figcaption><span class="caption">UserService</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient</span>(url = <span class="string">"$&#123;feign.service-user.url&#125;"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestLine</span>(<span class="string">"GET /&#123;context-path&#125;/api/v1/user/info/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function">Response&lt;SysUser&gt; <span class="title">userInfo</span><span class="params">(@Param(<span class="string">"id"</span>)</span> <span class="keyword">int</span> id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestLine</span>(<span class="string">"POST /&#123;context-path&#125;/api/v1/user/list"</span>)</span><br><span class="line">    <span class="meta">@Headers</span>(&#123;<span class="string">"Content-Type: application/json"</span>&#125;)</span><br><span class="line">    Response&lt;List&lt;SysUser&gt;&gt; list(SysUser user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="指定name（NameServiceChooser）"><a href="#指定name（NameServiceChooser）" class="headerlink" title="指定name（NameServiceChooser）"></a>指定name（NameServiceChooser）</h4><p>如果在spring容器中注入一个<code>NameServiceChooser</code>实例，那么便可以指定name来调用，这里假设服务使用了Eureka注册管理</p>
<figure class="highlight java"><figcaption><span class="caption">EurekaServiceChooser</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="meta">@ConditionalOnClass</span>(&#123;LoadBalancerClient<span class="class">.<span class="keyword">class</span>&#125;)</span></span><br><span class="line"><span class="class">@<span class="title">Component</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">EurekaServiceChooser</span> <span class="keyword">implements</span> <span class="title">NameServiceChooser</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LoadBalancerClient balancerClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">choose</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        ServiceInstance instance = balancerClient.choose(name.toUpperCase());</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"service["</span> + name + <span class="string">"] not exist"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance.getUri().toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里除了将url改成name之外，也指定了decoder和logger。指定ResponseDecoder可以在接收时直接获取数据，而不用自己判断code，指定logger可以方便对日志按模块进行配置。</p>
<figure class="highlight java"><figcaption><span class="caption">UserService</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient</span>(name = <span class="string">"service-user"</span>, decoder = ResponseDecoder<span class="class">.<span class="keyword">class</span>, <span class="title">logger</span> </span>= AccessLogger<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">interface</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestLine</span>(<span class="string">"GET /&#123;context-path&#125;/api/v1/user/info/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function">SysUser <span class="title">userInfo</span><span class="params">(@Param(<span class="string">"id"</span>)</span> <span class="keyword">int</span> id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestLine</span>(<span class="string">"POST /&#123;context-path&#125;/api/v1/user/list"</span>)</span><br><span class="line">    <span class="meta">@Headers</span>(&#123;<span class="string">"Content-Type: application/json"</span>&#125;)</span><br><span class="line">    <span class="function">List&lt;SysUser&gt; <span class="title">list</span><span class="params">(SysUser user)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="请求设置（RequestInterceptor）"><a href="#请求设置（RequestInterceptor）" class="headerlink" title="请求设置（RequestInterceptor）"></a>请求设置（RequestInterceptor）</h4><p>如果在调用过程中需要传递认证Token和请求requestId信息，那么可以在spring容器中注入<code>RequestInterceptor</code>实例，修改请求头信息</p>
<figure class="highlight java"><figcaption><span class="caption">FeignInterceptor</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FeignInterceptor</span> <span class="keyword">implements</span> <span class="title">RequestInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">apply</span><span class="params">(RequestTemplate requestTemplate)</span> </span>&#123;</span><br><span class="line">        String requestId = Access.id();</span><br><span class="line">        String authorization = Access.token();</span><br><span class="line">        <span class="keyword">if</span>(StringUtils.isBlank(requestId)) &#123;</span><br><span class="line">            requestId = requestId();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(StringUtils.isBlank(authorization) &amp;&amp; tokenService != <span class="keyword">null</span>) &#123;</span><br><span class="line">            authorization = newToken();</span><br><span class="line">        &#125;</span><br><span class="line">        requestTemplate.header(<span class="string">"requestId"</span>, requestId);</span><br><span class="line">        requestTemplate.header(<span class="string">"Authorization"</span>, authorization);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="不确定url（FeignManager）"><a href="#不确定url（FeignManager）" class="headerlink" title="不确定url（FeignManager）"></a>不确定url（FeignManager）</h4><p>通常我们都已经习惯了使用spring注入的方式，在应用启动时自动加载进行初始化，但是在有场景中确实无法提前确定url信息，那么也就无法在启动时加载实例，所以也提供了以下静态获取方法</p>
<figure class="highlight java"><figcaption><span class="caption">FeignManager</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">get</span><span class="params">(Class&lt;T&gt; clazz, String url)</span></span>;</span><br></pre></td></tr></table></figure>
<p>一种常见的场景是，我们约定好了请求和响应结构，但是地址是未知的。那么可以在类定义中先不指定url，等到真正创建实例时再作为参数传入</p>
<figure class="highlight java"><figcaption><span class="caption">TemporaryClient</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient</span>(connectTimeoutMillis = <span class="number">5000</span>, readTimeoutMillis = <span class="number">5000</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TemporaryClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestLine</span>(<span class="string">"POST"</span>)</span><br><span class="line">    <span class="meta">@Headers</span>(&#123;<span class="string">"Content-Type: application/json"</span>&#125;)</span><br><span class="line">    <span class="function">Response <span class="title">post</span><span class="params">(Object data)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestLine</span>(<span class="string">"GET"</span>)</span><br><span class="line">    <span class="function">Response <span class="title">get</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h3><p>对于示例中调用的两个接口，可以简单定义如下</p>
<figure class="highlight java"><figcaption><span class="caption">UserController</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Validated</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/api/v1/user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(value = &#123;<span class="string">"/info/&#123;id&#125;"</span>&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Response&lt;SysUser&gt; <span class="title">info</span><span class="params">(@PathVariable <span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Response.success(userService.info(id));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/list"</span>)</span><br><span class="line">    <span class="keyword">public</span> Response&lt;List&lt;SysUser&gt;&gt; list(<span class="meta">@RequestBody</span> SysUser sysUser) &#123;</span><br><span class="line">        <span class="keyword">return</span> Response.success(userService.list(sysUser));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="请求信息-Access"><a href="#请求信息-Access" class="headerlink" title="请求信息 Access"></a>请求信息 Access</h4><p>我们首先可以将请求相关的一些信息打包成<code>Access</code>存放在ThreadLocal中，然后方便在处理过程中进行获取和处理，使用TransmittableThreadLocal也是为了在发生异步线程处理时，依然能够获取到这些信息。</p>
<figure class="highlight java"><figcaption><span class="caption">Access</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Access</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Access&gt; LOCAL = <span class="keyword">new</span> TransmittableThreadLocal&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String requestIp;   <span class="comment">// 请求ip</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String requestId;   <span class="comment">// 请求id</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String requestUrl;  <span class="comment">// 请求路径</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Long requestTime;   <span class="comment">// 请求时间</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Locale locale;            <span class="comment">// 国际化语言类型</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> AccessToken accessToken;  <span class="comment">// 登录信息UserDetails</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> TreeMap&lt;String, Object&gt; requestParam;</span><br><span class="line"></span><br><span class="line">    Access(String language, String requestIp, String requestId, String requestUrl, Long requestTime)&#123;</span><br><span class="line">        <span class="keyword">this</span>.requestIp = requestIp;</span><br><span class="line">        <span class="keyword">this</span>.requestId = requestId;</span><br><span class="line">        <span class="keyword">this</span>.requestUrl = requestUrl;</span><br><span class="line">        <span class="keyword">this</span>.requestTime = requestTime;</span><br><span class="line">        <span class="keyword">this</span>.locale = Locale.getDefault();</span><br><span class="line">        <span class="keyword">if</span>(StringUtils.isNotBlank(language)) &#123;</span><br><span class="line">            <span class="keyword">if</span>(language.toLowerCase().contains(<span class="string">"en"</span>)) &#123;</span><br><span class="line">                <span class="keyword">this</span>.locale = <span class="keyword">new</span> Locale(<span class="string">"en"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(language.toLowerCase().contains(<span class="string">"zh"</span>)) &#123;</span><br><span class="line">                <span class="keyword">this</span>.locale = <span class="keyword">new</span> Locale(<span class="string">"zh"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(Access access)</span></span>&#123;</span><br><span class="line">        LOCAL.set(access);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> Access <span class="title">get</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> LOCAL.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span></span>&#123;</span><br><span class="line">        LOCAL.remove();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Locale <span class="title">language</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Access access;</span><br><span class="line">        <span class="keyword">if</span>((access = get()) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Locale.getDefault();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> access.locale;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">ip</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Access access;</span><br><span class="line">        <span class="keyword">if</span>((access = get()) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> access.requestIp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">id</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Access access;</span><br><span class="line">        <span class="keyword">if</span>((access = get()) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> access.requestId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">url</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Access access;</span><br><span class="line">        <span class="keyword">if</span>((access = get()) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> access.requestUrl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Date <span class="title">time</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Access access;</span><br><span class="line">        <span class="keyword">if</span>((access = get()) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Date();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Date(access.requestTime);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AccessToken <span class="title">accessToken</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Access access = get();</span><br><span class="line">        <span class="keyword">if</span>(access == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> access.accessToken;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">token</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Access access;</span><br><span class="line">        AccessToken accessToken;</span><br><span class="line">        <span class="keyword">if</span>((access = get()) == <span class="keyword">null</span> || (accessToken = access.accessToken) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> accessToken.getToken();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Long <span class="title">userId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Access access;</span><br><span class="line">        AccessToken accessToken;</span><br><span class="line">        <span class="keyword">if</span>((access = get()) == <span class="keyword">null</span> || (accessToken = access.accessToken) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> accessToken.getUserId();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">userCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Access access;</span><br><span class="line">        AccessToken accessToken;</span><br><span class="line">        <span class="keyword">if</span>((access = get()) == <span class="keyword">null</span> || (accessToken = access.accessToken) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> accessToken.getUserCode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">userAccount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Access access;</span><br><span class="line">        AccessToken accessToken;</span><br><span class="line">        <span class="keyword">if</span>((access = get()) == <span class="keyword">null</span> || (accessToken = access.accessToken) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> accessToken.getUsername();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">userName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Access access;</span><br><span class="line">        AccessToken accessToken;</span><br><span class="line">        <span class="keyword">if</span>((access = get()) == <span class="keyword">null</span> || (accessToken = access.accessToken) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> accessToken.getUsernick();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isAdmin</span><span class="params">()</span></span>&#123;</span><br><span class="line">        List&lt;String&gt; roles = userRoles();</span><br><span class="line">        <span class="keyword">if</span>(CollectionUtils.isEmpty(roles))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> roles.contains(<span class="string">"sysAdmin"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">userRoles</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Access access;</span><br><span class="line">        AccessToken accessToken;</span><br><span class="line">        <span class="keyword">if</span>((access = get()) == <span class="keyword">null</span> || (accessToken = access.accessToken) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> accessToken.getRoles();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">userPermissions</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Access access;</span><br><span class="line">        AccessToken accessToken;</span><br><span class="line">        <span class="keyword">if</span>((access = get()) == <span class="keyword">null</span> || (accessToken = access.accessToken) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> accessToken.getPermissions();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Long <span class="title">deptId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Access access;</span><br><span class="line">        AccessToken accessToken;</span><br><span class="line">        <span class="keyword">if</span>((access = get()) == <span class="keyword">null</span> || (accessToken = access.accessToken) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> accessToken.getDeptId();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">deptCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Access access;</span><br><span class="line">        AccessToken accessToken;</span><br><span class="line">        <span class="keyword">if</span>((access = get()) == <span class="keyword">null</span> || (accessToken = access.accessToken) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> accessToken.getDeptCode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">deptName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Access access;</span><br><span class="line">        AccessToken accessToken;</span><br><span class="line">        <span class="keyword">if</span>((access = get()) == <span class="keyword">null</span> || (accessToken = access.accessToken) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> accessToken.getDeptName();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Integer <span class="title">clusterId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Access access;</span><br><span class="line">        AccessToken accessToken;</span><br><span class="line">        <span class="keyword">if</span>((access = get()) == <span class="keyword">null</span> || (accessToken = access.accessToken) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> accessToken.getClusterId();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Integer <span class="title">clusterLevel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Access access;</span><br><span class="line">        AccessToken accessToken;</span><br><span class="line">        <span class="keyword">if</span>((access = get()) == <span class="keyword">null</span> || (accessToken = access.accessToken) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> accessToken.getClusterLevel();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">clusterName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Access access;</span><br><span class="line">        AccessToken accessToken;</span><br><span class="line">        <span class="keyword">if</span>((access = get()) == <span class="keyword">null</span> || (accessToken = access.accessToken) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> accessToken.getClusterName();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="requestId-分页设置"><a href="#requestId-分页设置" class="headerlink" title="requestId/分页设置"></a>requestId/分页设置</h4><p>这里我们定一个Filter，并将其优先级设置为最高。因为实现中默认是在HttpServletRequest的基础上来进行反射并设置requestId，如果前面的Filter对request进行了包装，那么反射就会出问题。具体在设置之前，会检查客户端是否已经在Header中传入了requestId，并以传入的为准。</p>
<figure class="highlight java"><figcaption><span class="caption">RequestIdFilter</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Order</span>(Ordered.HIGHEST_PRECEDENCE)</span><br><span class="line"><span class="meta">@WebFilter</span>(filterName = <span class="string">"requestIdFilter"</span>, urlPatterns = <span class="string">"/*"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestIdFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> IdGenerator idGenerator = <span class="keyword">new</span> IdGenerator();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;info.cluster.id:&#125;$&#123;server.port:8080&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String prefix;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;application.page.enable:false&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> pageEnable;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        HttpServletRequest req = (HttpServletRequest) request;</span><br><span class="line">        String requestId = req.getHeader(<span class="string">"requestId"</span>);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(requestId)) &#123;</span><br><span class="line">            requestId = getRequestId();</span><br><span class="line">            setRequestId(req, requestId);</span><br><span class="line">        &#125;</span><br><span class="line">        Thread.currentThread().setName(requestId);</span><br><span class="line"></span><br><span class="line">        String language = req.getHeader(<span class="string">"Accept-Language"</span>);</span><br><span class="line">        String requestIp = Utils.getRequestIp(req);</span><br><span class="line">        String requestUrl = req.getRequestURI();</span><br><span class="line">        Access.set(<span class="keyword">new</span> Access(language, requestIp, requestId, requestUrl, System.currentTimeMillis()));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(pageEnable)&#123;</span><br><span class="line">            <span class="comment">// 不太优雅，在这里加了一个动作，设置pageHelper</span></span><br><span class="line">            PageRequestWrapper pageRequestWrapper = <span class="keyword">new</span> PageRequestWrapper((HttpServletRequest) request, response);</span><br><span class="line">            pageRequestWrapper.checkAndSetPage();</span><br><span class="line">            chain.doFilter(pageRequestWrapper, response);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            chain.doFilter(request, response);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getRequestId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> idGenerator.generateIdWithDate(prefix, <span class="string">""</span>, <span class="string">"yyyyMMddHHmmss"</span>, <span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setRequestId</span><span class="params">(HttpServletRequest request, String value)</span> </span>&#123;</span><br><span class="line">        Class&lt;?&gt; clazz = request.getClass();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Field req = clazz.getDeclaredField(<span class="string">"request"</span>);</span><br><span class="line">            req.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            Object o = req.get(request);</span><br><span class="line"></span><br><span class="line">            Field coyoteRequest = o.getClass().getDeclaredField(<span class="string">"coyoteRequest"</span>);</span><br><span class="line">            coyoteRequest.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            Object oo = coyoteRequest.get(o);</span><br><span class="line"></span><br><span class="line">            Field headers = oo.getClass().getDeclaredField(<span class="string">"headers"</span>);</span><br><span class="line">            headers.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            MimeHeaders mine = (MimeHeaders) headers.get(oo);</span><br><span class="line">            mine.addValue(<span class="string">"requestId"</span>).setString(value);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// ignore, never should happened</span></span><br><span class="line">            AccessLogger.error(<span class="string">""</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于requestId的取值比较简单，就是时间加序列，并通过取余等办法保证id定长。这样通过比较时间和序列，可以估算出某段时间内大概的请求量</p>
<figure class="highlight java"><figcaption><span class="caption">IdGenerator</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IdGenerator</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicInteger index = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">generateIdWithDate</span><span class="params">(String prefix, String suffix, String dateFormat, <span class="keyword">int</span> indexLimit)</span></span>&#123;</span><br><span class="line">        Assert.isTrue(StringUtils.hasText(dateFormat), <span class="string">"dateFormat cannot be empty."</span>);</span><br><span class="line">        Assert.isTrue(indexLimit &gt; <span class="number">0</span>, <span class="string">"indexLimit must greater than 0."</span>);</span><br><span class="line">        </span><br><span class="line">        String date = <span class="keyword">new</span> SimpleDateFormat(dateFormat).format(System.currentTimeMillis());</span><br><span class="line">        <span class="keyword">int</span> limitLen = String.valueOf(indexLimit).length();</span><br><span class="line">        </span><br><span class="line">        StringBuilder builder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">if</span>(StringUtils.hasText(prefix))&#123; </span><br><span class="line">            builder.append(prefix);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        builder.append(date);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(StringUtils.hasText(suffix))&#123; </span><br><span class="line">            builder.append(suffix);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        String currentIndex = String.valueOf(index.incrementAndGet() % indexLimit);</span><br><span class="line">        <span class="keyword">int</span> currentLen = currentIndex.length(); </span><br><span class="line">        </span><br><span class="line">        <span class="keyword">int</span> currentLimit = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; currentLen; i++)&#123;</span><br><span class="line">            currentLimit *= <span class="number">10</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = currentIndex.length(); i &lt; limitLen; i++)&#123;</span><br><span class="line">            currentLimit *= <span class="number">10</span>;</span><br><span class="line">            <span class="keyword">if</span>(currentLimit &lt; indexLimit)&#123;</span><br><span class="line">                builder.append(<span class="string">'0'</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> builder.append(currentIndex).toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于分页设置，只要检测下请求是否传入了分页参数pageSize和pageNum，如果传入了就设置一下分页插件PageHelper。但是<code>application/json</code>类型的请求在获取参数时需要读取字节流，而字节流只能读取一次，所以办法是在Wrapper中先将字节流读取成字符串（用来获取参数），然后再对外提供一个获取字节流的方法将字符串转成字节，这样才不影响后面Filter的读取</p>
<figure class="highlight java"><figcaption><span class="caption">PageRequestWrapper</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PageRequestWrapper</span> <span class="keyword">extends</span> <span class="title">HttpServletRequestWrapper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String body = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PageRequestWrapper</span><span class="params">(HttpServletRequest request, ServletResponse response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(request);</span><br><span class="line">        request.setCharacterEncoding(<span class="string">"UTF-8"</span>);</span><br><span class="line">        response.setCharacterEncoding(<span class="string">"UTF-8"</span>);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.startsWithIgnoreCase(<span class="keyword">this</span>.getContentType(), MediaType.APPLICATION_JSON_VALUE)) &#123;</span><br><span class="line">            body = Utils.getRequestBody(request);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;    </span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BufferedReader <span class="title">getReader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(getInputStream()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServletInputStream <span class="title">getInputStream</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] bytes = body.getBytes(StandardCharsets.UTF_8);</span><br><span class="line">        <span class="keyword">final</span> ByteArrayInputStream bais = <span class="keyword">new</span> ByteArrayInputStream(bytes);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ServletInputStream() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">read</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> bais.read();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">available</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> bytes.length;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isFinished</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isReady</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setReadListener</span><span class="params">(ReadListener readListener)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkAndSetPage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        PageMethod.clearPage(); <span class="comment">// 线程池线程复用可能导致问题，所以要进行清除下</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotBlank(body) &amp;&amp; !body.startsWith(<span class="string">"["</span>)) &#123;</span><br><span class="line">            Map&lt;String, Object&gt; paramMap = JSON.parseObject(body, Map<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            <span class="keyword">if</span> (paramMap.containsKey(PAGE_NUM) &amp;&amp; paramMap.containsKey(PAGE_SIZE)) &#123;</span><br><span class="line">                Integer pageNum = Converts.toInt(paramMap.get(PAGE_NUM), <span class="number">1</span>);</span><br><span class="line">                Integer pageSize = Converts.toInt(paramMap.get(PAGE_SIZE), <span class="number">10</span>);</span><br><span class="line">                String orderByColumn = (String) paramMap.get(ORDER_COLUMN);</span><br><span class="line">                String isAsc = (String) paramMap.get(IS_ASC);</span><br><span class="line"></span><br><span class="line">                String orderBy = getOrderBy(orderByColumn, isAsc);</span><br><span class="line">                PageMethod.startPage(pageNum, pageSize, orderBy).setReasonable(<span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (getParameter(PAGE_NUM) != <span class="keyword">null</span> &amp;&amp; getParameter(PAGE_SIZE) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                Integer pageNum = Converts.toInt(getParameter(PAGE_NUM), <span class="number">1</span>);</span><br><span class="line">                Integer pageSize = Converts.toInt(getParameter(PAGE_SIZE), <span class="number">10</span>);</span><br><span class="line">                String orderByColumn = getParameter(ORDER_COLUMN);</span><br><span class="line">                String isAsc = getParameter(IS_ASC);</span><br><span class="line"></span><br><span class="line">                String orderBy = getOrderBy(orderByColumn, isAsc);</span><br><span class="line">                PageMethod.startPage(pageNum, pageSize, orderBy).setReasonable(<span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="日志打印-AccessLogger"><a href="#日志打印-AccessLogger" class="headerlink" title="日志打印 AccessLogger"></a>日志打印 AccessLogger</h4><p>这里会打印所有Controller接口的请求和响应，在打印响应时会检查是否存在远程调用链数据，另外提供了一些常用的日志打印方法，使用同一个Logger来打印请求处理过程中的日志，方便进行日志配置</p>
<figure class="highlight java"><figcaption><span class="caption">AccessLogger</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccessLogger</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(AccessLogger<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span>(required = <span class="keyword">false</span>)</span><br><span class="line">    <span class="keyword">private</span> AccessUserParser accessUserParser;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut</span>(<span class="string">"execution(public * *..*Controller.*(..)) &amp;&amp; !execution(public * de.codecentric.boot..*Controller.*(..)) "</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">point</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span>(<span class="string">"point()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">logRequest</span><span class="params">(JoinPoint point)</span> </span>&#123;</span><br><span class="line">        ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();</span><br><span class="line">        HttpServletRequest request = attributes.getRequest();</span><br><span class="line">        String url = request.getRequestURI();</span><br><span class="line">        String remote = request.getRemoteAddr();</span><br><span class="line">        String requestId = request.getHeader(<span class="string">"requestId"</span>);</span><br><span class="line">        Thread.currentThread().setName(requestId);</span><br><span class="line"></span><br><span class="line">        TreeMap&lt;String, Object&gt; map = <span class="keyword">new</span> TreeMap&lt;&gt;();</span><br><span class="line">        MethodSignature signature = (MethodSignature)point.getSignature();</span><br><span class="line">        String[] paramNames = signature.getParameterNames();</span><br><span class="line">        Object[] args = point.getArgs();</span><br><span class="line">        <span class="keyword">if</span>(paramNames != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; args.length; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span>(args[i] == <span class="keyword">null</span>)&#123;</span><br><span class="line">                    map.put(paramNames[i], <span class="keyword">null</span>);</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    Class&lt;?&gt; clazz = args[i].getClass();</span><br><span class="line">                    <span class="keyword">if</span> (<span class="string">"requestId"</span>.equals(paramNames[i])</span><br><span class="line">                            || MultipartFile[]<span class="class">.<span class="keyword">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">clazz</span>)</span></span><br><span class="line"><span class="class">                            || <span class="title">MultipartFile</span>.<span class="title">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">clazz</span>)</span></span><br><span class="line"><span class="class">                            || <span class="title">HttpServletRequest</span>.<span class="title">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">clazz</span>)</span></span><br><span class="line"><span class="class">                            || <span class="title">HttpServletResponse</span>.<span class="title">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">clazz</span>)</span></span><br><span class="line"><span class="class">                            || <span class="title">BeanPropertyBindingResult</span>.<span class="title">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">clazz</span>)</span></span><br><span class="line"><span class="class">                            || <span class="title">ExtendedServletRequestDataBinder</span>.<span class="title">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">clazz</span>)</span></span><br><span class="line"><span class="class">                            )</span>&#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span>(accessUserParser != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        accessUserParser.parse(clazz, args[i]);</span><br><span class="line">                    &#125;</span><br><span class="line">                    map.put(paramNames[i], args[i]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Access access = Access.get();</span><br><span class="line">        access.setRequestParam(map);</span><br><span class="line">        LOGGER.info(<span class="string">"&gt;&gt; request  &#123;&#125; &#123;&#125; &#123;&#125;"</span>, remote, url, JSON.toJSONString(map));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterReturning</span>(returning = <span class="string">"resp"</span>, pointcut = <span class="string">"point()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">logResponse</span><span class="params">(Object resp)</span> </span>&#123;</span><br><span class="line">        Access access = Access.get();</span><br><span class="line"></span><br><span class="line">        Integer code = <span class="keyword">null</span>;</span><br><span class="line">        String msg = <span class="keyword">null</span>;</span><br><span class="line">        Object data = <span class="keyword">null</span>;</span><br><span class="line">        List&lt;RemoteChain&gt; chains = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (resp != <span class="keyword">null</span> &amp;&amp; Response<span class="class">.<span class="keyword">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">resp</span>.<span class="title">getClass</span>())) </span>&#123;</span><br><span class="line">            Response&lt;?&gt; rsp = (Response&lt;?&gt;) resp;</span><br><span class="line">            rsp.setRequestId(access.getRequestId());</span><br><span class="line">            code = rsp.getCode();</span><br><span class="line">            msg = rsp.getMsg();</span><br><span class="line">            data = rsp.getData();</span><br><span class="line">            chains = rsp.getChains();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String url = access.getRequestUrl();</span><br><span class="line">        <span class="keyword">long</span> cost = <span class="number">0L</span>;</span><br><span class="line">        <span class="keyword">if</span>(access.getRequestTime() != <span class="keyword">null</span>)&#123;</span><br><span class="line">            cost = System.currentTimeMillis() - access.getRequestTime();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(resp == <span class="keyword">null</span> || !LOGGER.isDebugEnabled())&#123;</span><br><span class="line">            <span class="keyword">if</span>(chains != <span class="keyword">null</span>)&#123;</span><br><span class="line">                StringBuilder builder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">                RemoteChain.buildeTree(<span class="string">""</span>, chains, builder);</span><br><span class="line">                LOGGER.info(<span class="string">"&lt;&lt; response &#123;&#125; &#123;&#125;ms &#123;&#125; &#123;&#125;\n&#123;&#125;"</span>, code, cost, url, msg, builder);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">if</span>(code != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    LOGGER.info(<span class="string">"&lt;&lt; response &#123;&#125; &#123;&#125;ms &#123;&#125; &#123;&#125;"</span>, code, cost, url, msg);</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    LOGGER.info(<span class="string">"&lt;&lt; response &#123;&#125;ms &#123;&#125;"</span>, cost, url);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(chains != <span class="keyword">null</span>)&#123;</span><br><span class="line">                StringBuilder builder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">                RemoteChain.buildeTree(<span class="string">""</span>, chains, builder);</span><br><span class="line">                LOGGER.debug(<span class="string">"&lt;&lt; response &#123;&#125; &#123;&#125;ms &#123;&#125; &#123;&#125; &#123;&#125;\n&#123;&#125;"</span>, code, cost, url, msg, JSON.toJSONString(data), builder);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">if</span>(code != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    LOGGER.debug(<span class="string">"&lt;&lt; response &#123;&#125; &#123;&#125;ms &#123;&#125; &#123;&#125; &#123;&#125;"</span>, code, cost, url, msg, JSON.toJSONString(data));</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    LOGGER.debug(<span class="string">"&lt;&lt; response &#123;&#125;ms &#123;&#125; &#123;&#125;"</span>, cost, url, JSON.toJSONString(resp));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">info</span><span class="params">(String msg)</span></span>&#123;</span><br><span class="line">        LOGGER.info(msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">info</span><span class="params">(String format, Object... arguments)</span></span>&#123;</span><br><span class="line">        LOGGER.info(format, arguments);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">warn</span><span class="params">(String msg)</span></span>&#123;</span><br><span class="line">        LOGGER.warn(msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">warn</span><span class="params">(String format, Object... arguments)</span></span>&#123;</span><br><span class="line">        LOGGER.warn(format, arguments);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">error</span><span class="params">(String msg)</span></span>&#123;</span><br><span class="line">        LOGGER.error(msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">error</span><span class="params">(String format, Object... arguments)</span></span>&#123;</span><br><span class="line">        LOGGER.error(format, arguments);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样对于logback日志配置文件，我们就可以简单如下，具体细节不再赘述，主要将请求处理相关日志打印到access.log，其它的日志打印到root.log</p>
<figure class="highlight xml"><figcaption><span class="fileDir">resources/</span><span class="caption">logback-spring.xml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span> <span class="attr">scan</span>=<span class="string">"true"</span> <span class="attr">scanPeriod</span>=<span class="string">"60 seconds"</span> <span class="attr">debug</span>=<span class="string">"false"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"pattern"</span> <span class="attr">value</span>=<span class="string">"%d&#123;yyyy-MM-dd HH:mm:ss:SSS&#125; %thread [%level] %m%n"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"console"</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.ConsoleAppender"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.classic.encoder.PatternLayoutEncoder"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>$&#123;pattern&#125;<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"root"</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.RollingFileAppender"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">file</span>&gt;</span>$&#123;user.dir&#125;/log/root.log<span class="tag">&lt;/<span class="name">file</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">fileNamePattern</span>&gt;</span>$&#123;user.dir&#125;/log/root.log.%d&#123;yyyy-MM-dd&#125;.%i.zip<span class="tag">&lt;/<span class="name">fileNamePattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">maxFileSize</span>&gt;</span>20MB<span class="tag">&lt;/<span class="name">maxFileSize</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">maxHistory</span>&gt;</span>60<span class="tag">&lt;/<span class="name">maxHistory</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">totalSizeCap</span>&gt;</span>2GB<span class="tag">&lt;/<span class="name">totalSizeCap</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.classic.encoder.PatternLayoutEncoder"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>$&#123;pattern&#125;<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"access"</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.RollingFileAppender"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">file</span>&gt;</span>$&#123;user.dir&#125;/log/access.log<span class="tag">&lt;/<span class="name">file</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">fileNamePattern</span>&gt;</span>$&#123;user.dir&#125;/log/access.log.%d&#123;yyyy-MM-dd&#125;.%i.zip<span class="tag">&lt;/<span class="name">fileNamePattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">maxFileSize</span>&gt;</span>20MB<span class="tag">&lt;/<span class="name">maxFileSize</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">maxHistory</span>&gt;</span>60<span class="tag">&lt;/<span class="name">maxHistory</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">totalSizeCap</span>&gt;</span>2GB<span class="tag">&lt;/<span class="name">totalSizeCap</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.classic.encoder.PatternLayoutEncoder"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>$&#123;pattern&#125;<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">springProfile</span> <span class="attr">name</span>=<span class="string">"prod"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">"info"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"root"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">logger</span> <span class="attr">level</span>=<span class="string">"info"</span> <span class="attr">additivity</span>=<span class="string">"false"</span> <span class="attr">name</span>=<span class="string">"com.x.x.x.AccessLogger"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"access"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">logger</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">springProfile</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">springProfile</span> <span class="attr">name</span>=<span class="string">"dev"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">"info"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"console"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"root"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">logger</span> <span class="attr">level</span>=<span class="string">"info"</span> <span class="attr">additivity</span>=<span class="string">"false"</span> <span class="attr">name</span>=<span class="string">"com.x.x.x.AccessLogger"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"console"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"access"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">logger</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">springProfile</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>正常的请求响应日志大概如下所示，如果打开debug级别会打印响应内容</p>
<figure class="highlight plain"><figcaption><span class="caption">access.log</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2021-05-05 10:56:29:299 101900420230925105629001 [INFO] &gt;&gt; request  127.0.0.1 &#x2F;code&#x2F;api&#x2F;v1&#x2F;db&#x2F;preview&#x2F;1 &#123;&quot;id&quot;:1&#125;</span><br><span class="line">2021-05-05 10:56:29:546 101900420230925105629001 [INFO] &lt;&lt; response 200 399ms &#x2F;code&#x2F;api&#x2F;v1&#x2F;db&#x2F;preview&#x2F;1 Success</span><br></pre></td></tr></table></figure>
<h4 id="异常处理-AccessAdvice"><a href="#异常处理-AccessAdvice" class="headerlink" title="异常处理 AccessAdvice"></a>异常处理 AccessAdvice</h4><p>在接口返回时会统一进行异常处理，打印异常日志，并构造一个失败响应</p>
<figure class="highlight java"><figcaption><span class="caption">AccessAdvice</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccessAdvice</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ApplicationConfiguration applicationConfiguration;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AccessLogger accessLogger;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MessageHelper message;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;application.language.enable:false&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> languageEnable;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 参数转换</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@InitBinder</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initBinder</span><span class="params">(WebDataBinder binder)</span></span>&#123;</span><br><span class="line">        binder.registerCustomEditor(String<span class="class">.<span class="keyword">class</span>, <span class="title">new</span> <span class="title">StringTrimmerEditor</span>(<span class="title">true</span>))</span>;</span><br><span class="line">        binder.registerCustomEditor(Date<span class="class">.<span class="keyword">class</span>, <span class="title">new</span> <span class="title">PropertyEditorSupport</span>()</span>&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAsText</span><span class="params">(String text)</span></span>&#123;</span><br><span class="line">                setValue(DateUtils.parse(text));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(HttpRequestMethodNotSupportedException<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">Response</span>&lt;<span class="title">Void</span>&gt; <span class="title">handleHttpRequestMethodNotSupported</span>(<span class="title">HttpRequestMethodNotSupportedException</span> <span class="title">e</span>)</span>&#123;</span><br><span class="line">        AccessLogger.error(<span class="string">"Method Not Supported"</span>, e);</span><br><span class="line">        Response&lt;Void&gt; resp;</span><br><span class="line">        <span class="keyword">if</span>(languageEnable)&#123;</span><br><span class="line">            resp = Response.error(BAD_REQUEST, message.msg(<span class="string">"advice.httpRequestMethodNotSupportedException"</span>));</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            resp = Response.error(BAD_REQUEST, <span class="string">"Method not support"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        accessLogger.logResponse(resp);</span><br><span class="line">        <span class="keyword">return</span> resp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(HttpMessageConversionException<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">Response</span>&lt;<span class="title">Void</span>&gt; <span class="title">handleHttpMessageConversionException</span>(<span class="title">HttpMessageConversionException</span> <span class="title">e</span>)</span>&#123;</span><br><span class="line">        AccessLogger.error(<span class="string">"request convert failed"</span>, e);</span><br><span class="line">        Response&lt;Void&gt; resp;</span><br><span class="line">        <span class="keyword">if</span>(languageEnable)&#123;</span><br><span class="line">            resp = Response.error(BAD_REQUEST, message.msg(<span class="string">"advice.httpMessageConversionException"</span>));</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            resp = Response.error(BAD_REQUEST, <span class="string">"Message convert failed"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        accessLogger.logResponse(resp);</span><br><span class="line">        <span class="keyword">return</span> resp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(MethodArgumentNotValidException<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">Response</span>&lt;<span class="title">Void</span>&gt; <span class="title">handleMethodArgumentNotValidException</span>(<span class="title">MethodArgumentNotValidException</span> <span class="title">e</span>)</span>&#123;</span><br><span class="line">        AccessLogger.error(<span class="string">""</span>, e);</span><br><span class="line">        Response&lt;Void&gt; resp;</span><br><span class="line">        <span class="keyword">if</span>(languageEnable)&#123;</span><br><span class="line">            resp = Response.error(BAD_REQUEST, message.msg(Objects.requireNonNull(e.getBindingResult().getFieldError()).getDefaultMessage()));</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            resp = Response.error(BAD_REQUEST, Objects.requireNonNull(e.getBindingResult().getFieldError()).getDefaultMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        accessLogger.logResponse(resp);</span><br><span class="line">        <span class="keyword">return</span> resp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(BindException<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">Response</span>&lt;<span class="title">Void</span>&gt; <span class="title">handleBindException</span>(<span class="title">BindException</span> <span class="title">e</span>)</span>&#123;</span><br><span class="line">        AccessLogger.error(<span class="string">""</span>, e);</span><br><span class="line">        Response&lt;Void&gt; resp;</span><br><span class="line">        <span class="keyword">if</span>(languageEnable)&#123;</span><br><span class="line">            resp = Response.error(BAD_REQUEST, message.msg(e.getAllErrors().get(<span class="number">0</span>).getDefaultMessage()));</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            resp = Response.error(BAD_REQUEST, e.getAllErrors().get(<span class="number">0</span>).getDefaultMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        accessLogger.logResponse(resp);</span><br><span class="line">        <span class="keyword">return</span> resp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(ConstraintViolationException<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">Response</span>&lt;<span class="title">Void</span>&gt; <span class="title">handleConstraintViolationException</span>(<span class="title">ConstraintViolationException</span> <span class="title">e</span>)</span>&#123;</span><br><span class="line">        AccessLogger.error(<span class="string">""</span>, e);</span><br><span class="line">        Response&lt;Void&gt; resp;</span><br><span class="line">        <span class="keyword">if</span>(languageEnable)&#123;</span><br><span class="line">            resp = Response.error(BAD_REQUEST, message.msg(e.getMessage().split(<span class="string">": "</span>)[<span class="number">1</span>]));</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            resp = Response.error(BAD_REQUEST, e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        accessLogger.logResponse(resp);</span><br><span class="line">        <span class="keyword">return</span> resp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(IllegalArgumentException<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">Response</span>&lt;<span class="title">Void</span>&gt; <span class="title">handlerIllegalArgumentException</span>(<span class="title">IllegalArgumentException</span> <span class="title">e</span>)</span>&#123;</span><br><span class="line">        AccessLogger.error(<span class="string">""</span>, e);</span><br><span class="line">        Response&lt;Void&gt; resp;</span><br><span class="line">        <span class="keyword">if</span>(languageEnable)&#123;</span><br><span class="line">            resp = Response.error(BAD_REQUEST, message.msg(<span class="string">"advice.illegalArgumentException"</span>, e.getMessage()));</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            resp = Response.error(BAD_REQUEST, e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        accessLogger.logResponse(resp);</span><br><span class="line">        <span class="keyword">return</span> resp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(AssertsException<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">Response</span>&lt;<span class="title">Void</span>&gt; <span class="title">handlerAssertsException</span>(<span class="title">AssertsException</span> <span class="title">e</span>)</span>&#123;</span><br><span class="line">        AccessLogger.error(<span class="string">""</span>, e);</span><br><span class="line">        Response&lt;Void&gt; resp = Response.error(SYS_ERROR, e.getMessage());</span><br><span class="line">        accessLogger.logResponse(resp);</span><br><span class="line">        <span class="keyword">return</span> resp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(AccessDeniedException<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">Response</span>&lt;<span class="title">Void</span>&gt; <span class="title">handlerAccessDeniedException</span>(<span class="title">AccessDeniedException</span> <span class="title">e</span>)</span>&#123;</span><br><span class="line">        AccessLogger.error(<span class="string">""</span>, e);</span><br><span class="line">        Response&lt;Void&gt; resp;</span><br><span class="line">        <span class="keyword">if</span>(languageEnable)&#123;</span><br><span class="line">            resp = Response.error(FORBIDDEN, message.msg(<span class="string">"auth.denied"</span>));</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            resp = Response.error(FORBIDDEN, <span class="string">"Access denied"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        accessLogger.logResponse(resp);</span><br><span class="line">        <span class="keyword">return</span> resp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(SQLException<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">Response</span>&lt;<span class="title">Void</span>&gt; <span class="title">handlerSQLException</span>(<span class="title">SQLException</span> <span class="title">e</span>)</span>&#123;</span><br><span class="line">        AccessLogger.error(<span class="string">""</span>, e);</span><br><span class="line">        Response&lt;Void&gt; resp;</span><br><span class="line">        <span class="keyword">if</span>(languageEnable)&#123;</span><br><span class="line">            resp = Response.error(INTERNAL_SERVER_ERROR, message.msg(<span class="string">"advice.sqlException"</span>));</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            resp = Response.error(INTERNAL_SERVER_ERROR, <span class="string">"Sql failed"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        accessLogger.logResponse(resp);</span><br><span class="line">        <span class="keyword">return</span> resp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(DuplicateKeyException<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">Response</span>&lt;<span class="title">Void</span>&gt; <span class="title">handlerDuplicateKeyException</span>(<span class="title">DuplicateKeyException</span> <span class="title">e</span>)</span>&#123;</span><br><span class="line">        AccessLogger.error(<span class="string">""</span>, e);</span><br><span class="line">        Response&lt;Void&gt; resp;</span><br><span class="line">        <span class="keyword">if</span>(languageEnable)&#123;</span><br><span class="line">            resp = Response.error(INTERNAL_SERVER_ERROR, message.msg(<span class="string">"advice.duplicateKeyException"</span>));</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            resp = Response.error(INTERNAL_SERVER_ERROR, <span class="string">"Duplicate Key"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        accessLogger.logResponse(resp);</span><br><span class="line">        <span class="keyword">return</span> resp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(DataAccessException<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">Response</span>&lt;<span class="title">Void</span>&gt; <span class="title">handlerSQLException</span>(<span class="title">DataAccessException</span> <span class="title">e</span>)</span>&#123;</span><br><span class="line">        AccessLogger.error(<span class="string">""</span>, e);</span><br><span class="line">        Response&lt;Void&gt; resp;</span><br><span class="line">        <span class="keyword">if</span>(languageEnable)&#123;</span><br><span class="line">            resp = Response.error(INTERNAL_SERVER_ERROR, message.msg(<span class="string">"advice.dataAccessException"</span>));</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            resp = Response.error(INTERNAL_SERVER_ERROR, <span class="string">"Data access failed"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        accessLogger.logResponse(resp);</span><br><span class="line">        <span class="keyword">return</span> resp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(Exception<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">Response</span>&lt;<span class="title">Void</span>&gt; <span class="title">handlerException</span>(<span class="title">Exception</span> <span class="title">e</span>)</span>&#123;</span><br><span class="line">        AccessLogger.error(<span class="string">""</span>, e);</span><br><span class="line">        Response&lt;Void&gt; resp;</span><br><span class="line">        <span class="keyword">if</span>(languageEnable)&#123;</span><br><span class="line">            resp = Response.error(INTERNAL_SERVER_ERROR, message.msg(<span class="string">"advice.exception"</span>));</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            resp = Response.error(INTERNAL_SERVER_ERROR, <span class="string">"System error"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        accessLogger.logResponse(resp);</span><br><span class="line">        <span class="keyword">return</span> resp;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于响应中的异常提示会根据类型而进行不同的设置，对应的国际化资源可以定义如下</p>
<figure class="highlight properties"><figcaption><span class="caption">messages.properties</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">advice.httpRequestMethodNotSupportedException</span> = <span class="string">不支持的请求方法</span></span><br><span class="line"><span class="meta">advice.httpMessageConversionException</span>         = <span class="string">请求参数转换失败</span></span><br><span class="line"><span class="meta">advice.illegalArgumentException</span> = <span class="string">非法参数:&#123;0&#125;</span></span><br><span class="line"><span class="meta">advice.sqlException</span>             = <span class="string">数据操作失败</span></span><br><span class="line"><span class="meta">advice.duplicateKeyException</span>    = <span class="string">数据主键冲突</span></span><br><span class="line"><span class="meta">advice.dataAccessException</span>      = <span class="string">数据访问失败</span></span><br><span class="line"><span class="meta">advice.exception</span>                = <span class="string">系统异常</span></span><br><span class="line"></span><br><span class="line"><span class="meta">advice.httpRequestMethodNotSupportedException</span> = <span class="string">Method Not Supported</span></span><br><span class="line"><span class="meta">advice.httpMessageConversionException</span>         = <span class="string">Message Convert Failed</span></span><br><span class="line"><span class="meta">advice.illegalArgumentException</span> = <span class="string">&#123;0&#125;</span></span><br><span class="line"><span class="meta">advice.sqlException</span>             = <span class="string">Data Operation Failed</span></span><br><span class="line"><span class="meta">advice.duplicateKeyException</span>    = <span class="string">Data Key Conflict</span></span><br><span class="line"><span class="meta">advice.dataAccessException</span>      = <span class="string">Data Access Failed</span></span><br><span class="line"><span class="meta">advice.exception</span>                = <span class="string">System Error</span></span><br></pre></td></tr></table></figure>
<p>对于AssertsException的异常提示，则在具体业务方法中进行自定义设置，对应的提供了一些类似断言的常用判断</p>
<figure class="highlight java"><figcaption><span class="caption">Asserts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Asserts</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">isTrue</span><span class="params">(<span class="keyword">boolean</span> expression, String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!expression) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AssertsException(message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">isFalse</span><span class="params">(<span class="keyword">boolean</span> expression, String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (expression) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AssertsException(message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">notEquals</span><span class="params">(Object a, Object b, String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (Objects.equals(a, b)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AssertsException(message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">equals</span><span class="params">(Object a, Object b, String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!Objects.equals(a, b)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AssertsException(message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">notBlank</span><span class="params">(@Nullable String text, String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.hasText(text)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AssertsException(message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">isBlank</span><span class="params">(@Nullable String text, String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(text)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AssertsException(message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">notNull</span><span class="params">(@Nullable Object object, String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (object == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AssertsException(message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">isNull</span><span class="params">(@Nullable Object object, String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (object != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AssertsException(message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">notEmpty</span><span class="params">(@Nullable Map&lt;?, ?&gt; map, String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (ObjectUtils.isEmpty(map)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AssertsException(message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">isEmpty</span><span class="params">(@Nullable Map&lt;?, ?&gt; map, String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (ObjectUtils.isNotEmpty(map)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AssertsException(message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">notEmpty</span><span class="params">(@Nullable Collection&lt;?&gt; collection, String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(collection)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AssertsException(message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">isEmpty</span><span class="params">(@Nullable Collection&lt;?&gt; collection, String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!CollectionUtils.isEmpty(collection)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AssertsException(message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">notEmpty</span><span class="params">(@Nullable Object[] array, String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (org.springframework.util.ObjectUtils.isEmpty(array)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AssertsException(message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">isEmpty</span><span class="params">(@Nullable Object[] array, String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!org.springframework.util.ObjectUtils.isEmpty(array)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AssertsException(message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Async线程设置"><a href="#Async线程设置" class="headerlink" title="@Async线程设置"></a>@Async线程设置</h4><p>这里是希望能定义异步执行线程的名称，这样在处理过程中能够根据线程名与对应的请求处理关联起来，如前面所介绍的合并调用链记录，所以如果是请求处理的子线程，就将线程名称设置成以’-async’作为后缀。具体是通过由父线程经ThreadLocal传递的信息来判断，为了防止由于线程复用而导致误判需要在结束时进行清除（上次作为异步线程处理请求导致ThreadLocal有值，而本次是处理完全不相干的任务）。但是这样也有个问题，如果同一个请求发起多个异步操作，那么通过线程名称就无法区分它们，不过影响不大。</p>
<figure class="highlight java"><figcaption><span class="caption">SysThreadPool</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SysThreadPool</span> <span class="keyword">extends</span> <span class="title">ThreadPoolExecutor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SysThreadPool</span><span class="params">(TaskExecutionProperties.Pool pool)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(pool.getCoreSize(), pool.getMaxSize(), pool.getKeepAlive().toSeconds(),</span><br><span class="line">                TimeUnit.MILLISECONDS, <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;(pool.getQueueCapacity()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">beforeExecute</span><span class="params">(Thread t, Runnable r)</span> </span>&#123;</span><br><span class="line">        String requestId = Access.id();</span><br><span class="line">        <span class="keyword">if</span>(StringUtils.isNotBlank(requestId)) &#123;</span><br><span class="line">            t.setName(requestId + <span class="string">"-async"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">afterExecute</span><span class="params">(Runnable r, Throwable t)</span> </span>&#123;</span><br><span class="line">        Access.clear();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后将其设置为@Async的默认线程池，这里又用ThreadPoolTaskExecutor做一层包装是为了能应用spring提供的线程配置TaskExecutionProperties</p>
<figure class="highlight java"><figcaption><span class="caption">SysAsyncConfiguration</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="meta">@AutoConfigureBefore</span>(TaskExecutionAutoConfiguration<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">Configuration</span></span></span><br><span class="line"><span class="class">@<span class="title">EnableConfigurationProperties</span>(<span class="title">TaskExecutionProperties</span>.<span class="title">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">SysAsyncConfiguration</span> <span class="keyword">implements</span> <span class="title">AsyncConfigurer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TaskExecutionProperties taskExecutionProperties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(name = &#123; <span class="string">"applicationExecutor"</span> &#125;)</span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Executor <span class="title">getAsyncExecutor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        TaskExecutionProperties.Pool pool = taskExecutionProperties.getPool();</span><br><span class="line">        Shutdown shutdown = taskExecutionProperties.getShutdown();</span><br><span class="line">        SysTaskExecutor taskExecutor = <span class="keyword">new</span> SysTaskExecutor(<span class="keyword">new</span> SysThreadPool(pool));</span><br><span class="line">        taskExecutor.setAllowCoreThreadTimeOut(pool.isAllowCoreThreadTimeout());</span><br><span class="line">        taskExecutor.setWaitForTasksToCompleteOnShutdown(shutdown.isAwaitTermination());</span><br><span class="line">        <span class="keyword">if</span>(shutdown.isAwaitTermination()) &#123;</span><br><span class="line">            taskExecutor.setAwaitTerminationMillis(shutdown.getAwaitTerminationPeriod().toMillis());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> TtlExecutors.getTtlExecutor(taskExecutor);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AsyncUncaughtExceptionHandler <span class="title">getAsyncUncaughtExceptionHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SimpleAsyncUncaughtExceptionHandler();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br><strong>参考：</strong></p>

      
    </div>
	
    <footer>
      
	  
	    
	<nav id="pagination">
	  
		  <a class="alignleft prev" href="/2021/08/01/20210801/">
		    Netty Channel
		  </a>
	  
	  
	  
		  <a class="alignright next" href="/2021/05/03/20210503/">
		    Http调用工具spring-feign 设计文档
		  </a>
	  
	  <div class="clearfix"></div>
	</nav>
	
	    
        
  
  <div class="categories">
    <a href="/categories/开发笔记/">开发笔记</a>
  </div>


        
  
  <div class="tags">
    <a href="/tags/feign/">feign</a>
  </div>


         		        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk@latest/dist/gitalk.min.js"></script>
<script src="/js/md5.min.js"></script>
<div id="gitalk-container"></div>
<script type="text/javascript">
    var gitalk = new Gitalk({
        clientID: 'd7beb7890a79c73a3e3d',
        clientSecret: '80ea1fc195ae4b80cbd65ec9f1ce68d59595af4b',
        id: md5(window.location.pathname),
        repo: 'shanhm1991.github.io',
        owner: 'shanhm1991',
        admin: 'shanhm1991'
    })
    gitalk.render('gitalk-container')
</script>                              



</div></div>
    <aside id="sidebar" class="alignright">
  


  

<script src="/js/jquery-3.4.1.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){
    $("#os_ul").click(function(){ $("#os_li").toggle(); });
    $("#xx_ul").click(function(){ $("#xx_li").toggle(); });
});
</script>


  

  
<div class="widget catlog">
<h3 class="title">Catlog</h3>
<ul class="entry_catlog">
<ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Feign调用"><span class="toc-text">Feign调用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#指定url"><span class="toc-text">指定url</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#指定name（NameServiceChooser）"><span class="toc-text">指定name（NameServiceChooser）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#请求设置（RequestInterceptor）"><span class="toc-text">请求设置（RequestInterceptor）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#不确定url（FeignManager）"><span class="toc-text">不确定url（FeignManager）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FAQ"><span class="toc-text">FAQ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#请求信息-Access"><span class="toc-text">请求信息 Access</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#requestId-分页设置"><span class="toc-text">requestId&#x2F;分页设置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#日志打印-AccessLogger"><span class="toc-text">日志打印 AccessLogger</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#异常处理-AccessAdvice"><span class="toc-text">异常处理 AccessAdvice</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Async线程设置"><span class="toc-text">@Async线程设置</span></a></li></ol></li></ol>
</div>





  
</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">

  
  
      &copy; 2017-2023 &nbsp;&nbsp; shanhm1991 &nbsp;&nbsp; version@1.0.0 
  
  
  
  <font style="float: right">
</div>
<div class="clearfix"></div>
</footer>
  
<script src="/js/jquery-3.4.1.min.js"></script>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>
</body>
</html>
